<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×˜×™×—×•×ª ×‘××© - ×”×™×©×¨×“×•×ª ×•×—×™×“×•×Ÿ</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #2d5a27; }
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            border: 3px solid #4CAF50;
            text-align: right;
            pointer-events: auto;
            color: #333;
            min-width: 260px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .stars-display { font-size: 24px; color: #ffcc00; margin-bottom: 5px; }
        #mission-title { font-weight: bold; font-size: 18px; color: #2d5a27; }
        #mission-desc { font-size: 16px; margin-top: 5px; color: #444; }
        
        /* Quiz Styles */
        #quiz-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #4CAF50;
            text-align: center;
            display: none;
            z-index: 2000;
            pointer-events: auto;
            max-width: 450px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .quiz-option {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #f0f0f0;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        .quiz-option:hover { background: #e0e0e0; border-color: #4CAF50; }

        #message-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            border: 5px solid #ff4444;
            text-align: center;
            display: none;
            z-index: 100;
            pointer-events: auto;
        }

        #victory-screen {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 3000;
            pointer-events: auto;
            color: white;
        }
        #victory-screen h1 { color: #ffcc00; font-size: 60px; margin-bottom: 20px; text-shadow: 0 0 20px #ffaa00; }

        .inventory {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            pointer-events: auto;
        }

        #interaction-prompt {
            position: absolute;
            top: 65%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 20px;
            border-radius: 10px;
            font-weight: bold;
            display: none;
            border: 2px solid #4CAF50;
        }
        button { padding: 10px 20px; cursor: pointer; border-radius: 8px; border: none; background: #4CAF50; color: white; font-weight: bold; }
        
        #controls-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            color: #333;
        }
    </style>
</head>
<body>

    <div id="ui">
        <div class="hud">
            <div class="stars-display" id="stars-ui">â­â­â­</div>
            <div id="mission-title">××©×™××” × ×•×›×—×™×ª:</div>
            <div id="mission-desc">×’×© ×œ××–×•×¨ ×”××©××‘×™×</div>
        </div>

        <div class="inventory" id="inv-ui">×’×–×¢×™ ×¢×¥: 0</div>

        <div id="interaction-prompt" class="interaction-prompt">×œ×—×¥ ×¢×œ [E]</div>

        <div id="quiz-box">
            <h2 id="quiz-question">×©××œ×”</h2>
            <div id="quiz-options"></div>
        </div>

        <div id="message-box">
            <h2 id="msg-title">×”×•×“×¢×”</h2>
            <p id="msg-body"></p>
            <button onclick="closeMessage()">×”×‘× ×ª×™</button>
        </div>

        <div id="victory-screen">
            <h1>×›×œ ×”×›×‘×•×“!</h1>
            <p style="font-size: 24px;">×œ××“×ª ××™×š ×œ×”×“×œ×™×§ ××© ×‘×œ×™ ×¡×›× ×•×ª!</p>
            <button onclick="location.reload()" style="font-size: 20px; margin-top: 20px;">×©×—×§ ×©×•×‘</button>
        </div>

        <div id="controls-hint">
            ×ª× ×•×¢×”: ×—×™×¦×™× ××• WASD | ×¤×¢×•×œ×”: E | ××¦×œ××”: ×¢×›×‘×¨ ×™×× ×™
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, player, clock;
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let campfire, resourceArea, dryGrass, lighter;
        let trees = [];
        let isUIOpen = false;
        
        let gameState = "START";
        let logs = 0;
        let hasAxe = false;
        let fireLit = false;

        let theta = Math.PI, phi = Math.PI / 4, radius = 15, isRightMouseDown = false;

        const quizzes = {
            "CRAFT_AXE": {
                question: "×œ×¤× ×™ ×©××ª×—×™×œ×™×, ××” ×”×›×™ ×—×©×•×‘ ×œ×•×•×“× ×›×©××“×œ×™×§×™× ××© ×‘×˜×‘×¢?",
                options: [
                    { text: "×©×™×© ××¡×¤×™×§ ××•×›×œ ×œ×¤×™×§× ×™×§", correct: false },
                    { text: "×©×”××–×•×¨ × ×§×™ ××¢×©×‘×™× ×™×‘×©×™× ×•××•×§×£ ×‘××‘× ×™×", correct: true },
                    { text: "×©×”×¨×•×— ×—×–×§×” ×××•×“", correct: false }
                ]
            },
            "LIGHT_FIRE": {
                question: "×”×× ××•×ª×¨ ×œ×”×©××™×¨ ××“×•×¨×” ×“×•×œ×§×ª ×‘×œ×™ ×”×©×’×—×” ××¤×™×œ×• ×œ×¨×’×¢?",
                options: [
                    { text: "×›×Ÿ, ×× ×–×” ×¨×§ ×œ×“×§×”", correct: false },
                    { text: "×¨×§ ×× ×™×© ××™× ×‘×¡×‘×™×‘×”", correct: false },
                    { text: "×‘×©×•× ×¤× ×™× ×•××•×¤×Ÿ ×œ×!", correct: true }
                ]
            }
        };

        init();
        animate();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87ceeb);
            
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 0.8);
            sun.position.set(10, 20, 10);
            scene.add(sun);

            const ground = new THREE.Mesh(new THREE.PlaneGeometry(100, 100), new THREE.MeshStandardMaterial({ color: 0x2d5a27 }));
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            createForest();
            createResourceArea(-15, -15);
            createCampfireArea(0, 0);
            createDryGrass(-10, 0, 10);
            createLighter(10, 0, -10);

            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.4, 1.2), new THREE.MeshStandardMaterial({color: 0x3498db}));
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.4), new THREE.MeshStandardMaterial({color: 0xfccb90}));
            head.position.y = 0.8;
            player.add(body, head);
            player.position.set(5, 0.6, 5);
            scene.add(player);

            window.addEventListener('keydown', e => {
                if(isUIOpen) return;
                // ×ª×™×§×•×Ÿ ×›×™×•×•× ×™ ×”×—×™×¦×™× ×•××§×œ×“×ª
                if(e.code === 'KeyW' || e.code === 'ArrowUp') moveForward = true;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') moveBackward = true;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') moveLeft = true;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') moveRight = true;
                if(e.code === 'KeyE') handleInteraction();
            });
            window.addEventListener('keyup', e => {
                if(e.code === 'KeyW' || e.code === 'ArrowUp') moveForward = false;
                if(e.code === 'KeyS' || e.code === 'ArrowDown') moveBackward = false;
                if(e.code === 'KeyA' || e.code === 'ArrowLeft') moveLeft = false;
                if(e.code === 'KeyD' || e.code === 'ArrowRight') moveRight = false;
            });

            window.addEventListener('mousedown', e => { if(e.button === 2) isRightMouseDown = true; });
            window.addEventListener('mouseup', e => { isRightMouseDown = false; });
            window.addEventListener('mousemove', e => {
                if(isRightMouseDown) {
                    theta -= e.movementX * 0.01;
                    phi = Math.max(0.1, Math.min(Math.PI/2.1, phi + e.movementY * 0.01));
                }
            });

            clock = new THREE.Clock();
            updateMission();
        }

        function createForest() {
            for(let i=0; i<30; i++) {
                const x = Math.random()*80-40, z = Math.random()*80-40;
                if(Math.abs(x)<10 && Math.abs(z)<10) continue;
                const tree = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.4, 3), new THREE.MeshStandardMaterial({color: 0x4d2926}));
                const leaves = new THREE.Mesh(new THREE.ConeGeometry(1.5, 4, 8), new THREE.MeshStandardMaterial({color: 0x1a3d16}));
                leaves.position.y = 2.5;
                tree.add(trunk, leaves);
                tree.position.set(x, 1.5, z);
                scene.add(tree);
                trees.push(tree);
            }
        }

        function createResourceArea(x, z) {
            resourceArea = new THREE.Group();
            const marker = new THREE.Mesh(new THREE.CircleGeometry(3, 32), new THREE.MeshBasicMaterial({color: 0xffffff, transparent: true, opacity: 0.2}));
            marker.rotation.x = -Math.PI/2;
            resourceArea.add(marker);
            resourceArea.position.set(x, 0.05, z);
            scene.add(resourceArea);
        }

        function createCampfireArea(x, z) {
            campfire = new THREE.Group();
            const ring = new THREE.Mesh(new THREE.TorusGeometry(1.2, 0.2, 8, 16), new THREE.MeshStandardMaterial({color: 0x777777}));
            ring.rotation.x = Math.PI/2;
            campfire.add(ring);
            const fire = new THREE.Mesh(new THREE.ConeGeometry(0.7, 1.5, 8), new THREE.MeshStandardMaterial({color: 0xff4400, transparent: true, opacity: 0}));
            fire.position.y = 0.7; fire.name = "fireMesh";
            campfire.add(fire);
            campfire.position.set(x, 0.1, z);
            scene.add(campfire);
        }

        function createDryGrass(x, y, z) {
            dryGrass = new THREE.Mesh(new THREE.SphereGeometry(0.5, 8, 8), new THREE.MeshStandardMaterial({color: 0xd2b48c}));
            dryGrass.position.set(x, 0.3, z);
            scene.add(dryGrass);
        }

        function createLighter(x, y, z) {
            lighter = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.6, 0.2), new THREE.MeshStandardMaterial({color: 0xff0000}));
            lighter.position.set(x, 0.3, z);
            scene.add(lighter);
        }

        function handleInteraction() {
            const distToFire = player.position.distanceTo(campfire.position);
            const distToRes = player.position.distanceTo(resourceArea.position);

            if (gameState === "START" && distToRes < 4) {
                startQuiz("CRAFT_AXE", () => {
                    hasAxe = true;
                    gameState = "CHOP_TREES";
                    updateMission();
                    updateInventory();
                    showMessage("×”×¦×œ×—×ª ×‘×—×™×“×•×Ÿ!", "×§×™×‘×œ×ª ×’×¨×–×Ÿ. ×¢×›×©×™×• ×›×¨×•×ª 2 ×¢×¦×™× ×‘×™×¢×¨ (×œ×—×¥ E ×œ×™×“ ×¢×¥).");
                });
            }
            else if (gameState === "CHOP_TREES" && hasAxe) {
                trees.forEach((t, i) => {
                    if(player.position.distanceTo(t.position) < 3) {
                        scene.remove(t); trees.splice(i, 1);
                        logs++; updateInventory();
                        if(logs >= 2) { gameState = "PLACE_WOOD"; updateMission(); }
                    }
                });
            }
            else if (gameState === "PLACE_WOOD" && distToFire < 3) {
                gameState = "GET_ITEMS";
                updateMission();
                showMessage("×”×¢×¥ ×‘××§×•×", "×¢×›×©×™×• ××¡×•×£ ×¢×©×‘ ×™×‘×© ×•××¦×™×ª ××”×™×¢×¨.");
            }
            else if (gameState === "GET_ITEMS") {
                if(player.position.distanceTo(dryGrass.position) < 2) scene.remove(dryGrass);
                if(player.position.distanceTo(lighter.position) < 2) scene.remove(lighter);
                if(!scene.children.includes(dryGrass) && !scene.children.includes(lighter)) {
                    gameState = "LIGHT_FIRE";
                    updateMission();
                }
            }
            else if (gameState === "LIGHT_FIRE" && distToFire < 3) {
                startQuiz("LIGHT_FIRE", () => {
                    fireLit = true;
                    campfire.getObjectByName("fireMesh").material.opacity = 1;
                    gameState = "WIN";
                    document.getElementById('victory-screen').style.display = 'flex';
                });
            }
        }

        function startQuiz(quizKey, onSuccess) {
            const quiz = quizzes[quizKey];
            isUIOpen = true;
            moveForward = moveBackward = moveLeft = moveRight = false;
            const box = document.getElementById('quiz-box');
            document.getElementById('quiz-question').innerText = quiz.question;
            const optionsDiv = document.getElementById('quiz-options');
            optionsDiv.innerHTML = '';
            
            quiz.options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'quiz-option';
                btn.innerText = opt.text;
                btn.onclick = () => {
                    if(opt.correct) {
                        box.style.display = 'none';
                        isUIOpen = false;
                        onSuccess();
                    } else {
                        alert("×˜×¢×•×ª! ×¢× ×™×ª ×œ× × ×›×•×Ÿ ×¢×œ ×›×œ×œ×™ ×”×‘×˜×™×—×•×ª. ×”××©×—×§ ××ª×—×™×œ ××”×ª×—×œ×”.");
                        location.reload();
                    }
                };
                optionsDiv.appendChild(btn);
            });
            box.style.display = 'block';
        }

        function updateMission() {
            const d = document.getElementById('mission-desc');
            if(gameState === "START") d.innerText = "×’×© ×œ××–×•×¨ ×”××©××‘×™× (×”×¢×™×’×•×œ ×”×œ×‘×Ÿ)";
            if(gameState === "CHOP_TREES") d.innerText = `×›×¨×•×ª ×¢×¦×™× (${logs}/2)`;
            if(gameState === "PLACE_WOOD") d.innerText = "×©×™× ××ª ×”×¢×¥ ×‘××“×•×¨×” [E]";
            if(gameState === "GET_ITEMS") d.innerText = "××¡×•×£ ×¢×©×‘ ×•××¦×™×ª ××”×™×¢×¨";
            if(gameState === "LIGHT_FIRE") d.innerText = "×”×“×œ×§ ××ª ×”××“×•×¨×” [E]";
        }

        function updateInventory() {
            document.getElementById('inv-ui').innerText = `×’×–×¢×™ ×¢×¥: ${logs} ${hasAxe ? '| ğŸª“ ×’×¨×–×Ÿ' : ''}`;
        }

        function showMessage(title, body) {
            isUIOpen = true;
            moveForward = moveBackward = moveLeft = moveRight = false;
            document.getElementById('msg-title').innerText = title;
            document.getElementById('msg-body').innerText = body;
            document.getElementById('message-box').style.display = 'block';
        }

        function closeMessage() {
            isUIOpen = false;
            document.getElementById('message-box').style.display = 'none';
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();

            if(!isUIOpen) {
                if(moveForward || moveBackward || moveLeft || moveRight) {
                    const dir = new THREE.Vector3();
                    // ×ª×™×§×•×Ÿ ×œ×•×’×™×§×ª ×ª× ×•×¢×”: ×§×“×™××” ×–×” ××™× ×•×¡ Z, ××—×•×¨×” ×–×” ×¤×œ×•×¡ Z
                    if(moveForward) dir.z -= 1;
                    if(moveBackward) dir.z += 1;
                    if(moveLeft) dir.x -= 1;
                    if(moveRight) dir.x += 1;
                    
                    dir.normalize().applyAxisAngle(new THREE.Vector3(0,1,0), theta - Math.PI);
                    player.position.add(dir.multiplyScalar(10 * delta));
                    player.rotation.y = Math.atan2(dir.x, dir.z);
                }

                let near = false;
                if(player.position.distanceTo(resourceArea.position) < 4) near = true;
                if(player.position.distanceTo(campfire.position) < 3) near = true;
                trees.forEach(t => { if(player.position.distanceTo(t.position) < 3) near = true; });
                if(scene.children.includes(dryGrass) && player.position.distanceTo(dryGrass.position) < 2.5) near = true;
                if(scene.children.includes(lighter) && player.position.distanceTo(lighter.position) < 2.5) near = true;
                document.getElementById('interaction-prompt').style.display = near ? 'block' : 'none';
            }

            camera.position.set(
                player.position.x + radius * Math.sin(theta) * Math.cos(phi),
                player.position.y + radius * Math.sin(phi),
                player.position.z + radius * Math.cos(theta) * Math.cos(phi)
            );
            camera.lookAt(player.position);

            if(fireLit) {
                campfire.getObjectByName("fireMesh").scale.y = 1 + Math.sin(Date.now()*0.01)*0.2;
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>